name: Replace/Revert Database Placeholders

permissions:
  contents: write

on:
  push:
    branches:
      - main
      - dev
      - qat
      - prd

jobs:
  replace-env:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Process placeholders
        run: |
          BRANCH="${GITHUB_REF_NAME^^}"   # uppercase branch name (dev -> DEV)

          if [[ "$BRANCH" == "MAIN" ]]; then
            echo "ðŸ”„ Reverting databases back to placeholders for main branch"
            find . -type f -name "*.sql" | while read file; do
              # Look for DEV_*/QAT_*/PRD_* patterns and revert
              sed -i "s/DEV_\([A-Z0-9_]\+\)/{DATABASE_\1}/g" "$file"
              sed -i "s/QAT_\([A-Z0-9_]\+\)/{DATABASE_\1}/g" "$file"
              sed -i "s/PRD_\([A-Z0-9_]\+\)/{DATABASE_\1}/g" "$file"
            done
          else
            echo "ðŸ”„ Replacing placeholders with $BRANCH_ prefixes"
            find . -type f -name "*.sql" | while read file; do
              for placeholder in $(grep -o "{DATABASE_[A-Z0-9_]\+}" "$file" | sort -u); do
                base=$(echo $placeholder | sed 's/[{}]//g')   # DATABASE_XYZ
                dbname=$(echo $base | sed "s/DATABASE_/${BRANCH}_/")  # DEV_XYZ / QAT_XYZ / PRD_XYZ
                echo "Replacing $placeholder -> $dbname in $file"
                sed -i "s/$placeholder/$dbname/g" "$file"
              done
            done
          fi

      - name: Commit changes back
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Auto-processed DB placeholders for ${GITHUB_REF_NAME}" || echo "No changes"
          git push
