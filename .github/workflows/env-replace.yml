name: Replace Database Placeholders

permissions:
  contents: write

on:
  push:
    branches:
      - dev
      - qat
      - prd

jobs:
  replace-env:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Replace placeholders dynamically
        run: |
          # Detect branch
          BRANCH="${GITHUB_REF_NAME^^}"   # makes it UPPERCASE (dev -> DEV)
          
          echo "Running replacement for branch: $BRANCH"

          # Replace all placeholders of the form {DATABASE_XYZ}
          find . -type f -name "*.sql" | while read file; do
            # Find all unique placeholders in file
            for placeholder in $(grep -o "{DATABASE_[A-Z0-9_]\+}" "$file" | sort -u); do
              base=$(echo $placeholder | sed 's/[{}]//g')   # DATABASE_XYZ
              dbname=$(echo $base | sed "s/DATABASE_/${BRANCH}_/")  # DEV_XYZ / QAT_XYZ / PRD_XYZ
              echo "Replacing $placeholder -> $dbname in $file"
              sed -i "s/$placeholder/$dbname/g" "$file"
            done
          done

      - name: Commit changes back
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Auto-replaced DB placeholders for ${GITHUB_REF_NAME}" || echo "No changes"
          git push
